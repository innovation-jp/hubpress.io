= Pythonで購入履歴を使ったレコメンドを作成してみた②　〜AWS Lambda編〜
:hp-tags: nakamura,AWS,Lambda,Python,レコメンド,Recommend

どうも、中村です。

前回に作成したプログラムだけでは実際に利用するのが難しいので、AWS Lambda + API Gatewayを使ってAPI化していきたいと思います。

※ちょっと長くなりそうだったので、API Gateway編は次回書きます。

=== 前回作成した構成


```
├── data.py ← 履歴データ
└── get_recommend.py ← レコメンド取得プログラム
```

こちらをAWS Lambdaに設定していくのですが、デプロイするためにファイルを圧縮したものを作成しましょう。

上記ディレクトリへ移動した後に以下コマンドを実行すれば、全てのファイルを圧縮したものが作成されます。

```
$ zip -r get_recommend.zip *
```
実行後

```
├── data.py
├── get_recommend.py
└── get_recommend.zip
```

get_recommend.zip というファイルをLambda関数の作成時に使用していきます。


=== AWS Lambda関数の作成

では早速Lambda関数を作成していきましょう。

image:/images/nakamura/lambda/01.png[]
関数の作成をクリック。


image:/images/nakamura/lambda/02.png[]
「一から作成」を選びます。（デフォルトで選択済み）


image:/images/nakamura/lambda/03.png[]
名前は分かりやすいものでOK。 +
ランタイムには前回Python3系で作成したので、「Python 3.6」を選択します。


image:/images/nakamura/lambda/04.png[]
今回新規のロールを作成するので、「テンプレートから新しいロールを作成」を選択。 +
ロール名も分かりやすいものであれば適当でOKです。


image:/images/nakamura/lambda/05.png[]
Lambda関数が無事作成されました。


=== コードをアップロードする

それでは前回作成したコードをアップロードしていきます。

image:/images/nakamura/lambda/06.png[]
関数コードというパネルのコードエントリタイプから「.ZIPファイルをアップロード」を選択し、先ほど作成した「get_recommend.zip」を選択します。


image:/images/nakamura/lambda/07.png[]
右上の「保存」ボタンをクリックするとアップロードされた内容が表示され、コンソール上で編集が可能になります。


image:/images/nakamura/lambda/08.png[]


=== コードを修正する

前回作成したプログラムはコンソール上から実行させるものでしたので、修正する必要があります。

大まかに説明すると、以下の2点になります。
```
・ コマンドライン引数は使用しない
・ メイン部分をハンドラーへ変更
```

それぞれ修正していきましょう。
image:/images/nakamura/lambda/09.png[]


image:/images/nakamura/lambda/10.png[]
メイン部分も変更していきます。 +
コマンドライン引数にて渡していた「対象製品ID」は、handlerのeventから取得するようにします。

image:/images/nakamura/lambda/11.png[]
最後に関数コードパネルの上部にあるハンドラ部分を、今回のプログラムに合うように変更します。

get_recommend.pyのlambda_handlerを実行させたいので、
```
get_recommend.lambda_handler
```
とします。


=== テストイベントの設定

修正したコードをデバッグしていきたいので、テストイベントを設定していきましょう。

image:/images/nakamura/lambda/12.png[]
画面上部にある「テスト」ボタンをクリックします。


image:/images/nakamura/lambda/13.png[]
イベントテンプレートは「Hello World」でOK。（デフォルトで選択済み） 

イベント名は何でも良いです。 + 
（個人的には渡す値などが判別できる名称にしたかったのですが、英数字のみに限定されているため上手く表現できませんでした）

最下部の編集エリアには、テスト時に渡したい値などを記入しておきます。 

上記のように記述しておくと、Lambda関数側で以下のように値を渡すことができます。
```
def lambda_handler(event, context):
    print(event.product_ids) ←"111,222"
```




=== 感想



こちらからは以上です！


