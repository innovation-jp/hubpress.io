# Laravel,Golangプロジェクトの開発環境について考えてみる(Docker)
:hp-alt-title: GoogleSpreadSheetで文字列から数字のみを抽出する方法のひとつ
:hp-tags: kohe, Docker, git

## みなさんこんにちは
こへです。
そろそろ、開発環境周りについていろいろ語りたい時期がきましたので記載

## どんなプロジェクトか？
FW移行

|=======================
|サーバサイド| Laravel
|フロントサイド|Vuejs
|バッチ        |Golang
|環境          |Docker
|DB           |Postgres9系→10系へ
table構成も変更
|インフラ          |Kubernetes
|=======================


## Gitリポジトリ構成

リポジトリを4つ使用＆submodule化

* DevEnv
** Online
** Batch
** Docker
** Embulk

## docker-compose.yml

docker-compose.ymlはDevEnvリポジトリにおいておく

全部で11コンテナも必要…

- nginx
- php
- node
- mailhog
- redis
- redis-2
- go
- stub(go)
- postgres-old
- postgres-new
- embulk


```
version: '3.7'
services:
#online
  nginx:
    build:
      context: ./Docker/online/nginx
    depends_on:
      - php
      - redis
      - mailhog
      - new-postgres
      - node
    ports:
      - 443:443
    volumes:
      - ./online/var/www:/var/www:cached
    environment:
      - TZ=Asia/Tokyo

  mailhog:
    image: mailhog/mailhog
    ports:
      - "8025:8025"
      - "1025:1025"

  redis:
    image: redis:3
    container_name: lf-redis1
    ports:
      - "6379:6379"

  php:
    build:
      context: ./Docker/online/phpfpm
    volumes:
      - ./online/var/www:/var/www:cached
      - ./Docker/online/phpfpm/usr/local/etc/php/php.ini:/usr/local/etc/php/php.ini:cached
    environment:
      - TZ=Asia/Tokyo

  node:
    image: node
    tty: true
    volumes:
      - ./online/var/www:/var/www:cached
    working_dir: /var/www/listfinder

#batch
  batch:
    build:
      context: ./Docker/batch
    depends_on:
     - fw-postgres
     - redis-shorturl
     - stub
     - mailhog
    volumes:
     - ./go/src/github.com/:/go/src/github.com/
     - ./go/temp:/temp
    #covarage のhtml出力を見るため
     - ./go/tmp:/tmp
    working_dir: /go/src/github.com
    ports:
     - "6060:6060"
    #debugができるようプロセスの監視を許可する
    security_opt:
     - seccomp:unconfined
    env_file:
      - ./Docker/batch/.go_env
    environment:
      - TZ=Asia/Tokyo
    command: ["godoc", "-http=:6060"]

  stub:
    image: golang:latest
    ports:
     - "9090:9090"
    volumes:
     - ./stub:/go/stub
    working_dir: /go/stub/api
    command: ["go", "run", "main.go"]

  redis-two:
    image: redis:3
    container_name: redis-tow
    ports:
      - "63790:6379"

#昔のpostgres
  postgres:
    image: xxxxxxxx/postgres:latest
    container_name: old-postgres
    ports:
      - "5432:5432"

  new-postgres:
    image: postgres:10
    ports:
      - "54320:5432"
    environment:
      POSTGRES_DB: listfinder
    volumes:
      - ./embulk/postgres_init:/docker-entrypoint-initdb.d
      - ./postgresql/data:/var/lib/postgresql/data
    environment:
      - TZ=Asia/Tokyo

  embulk:
    image: kooooohe/embulk
    depends_on:
      - postgres
      - fw-postgres
    container_name: embulk
    volumes:
      - ./embulk/opt/listfinder:/opt/listfinder
    env_file:
      - ./Docker/embulk/.env

```