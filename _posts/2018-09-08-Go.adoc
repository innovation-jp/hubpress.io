# Goのプロファイラ！
:hp-tags: NewTsukamoto, mac, Golang, 

こんにちは。
エンジニアのNew塚本です。

引き続き、Golangでバッチをゴリゴリ製造している毎日です。 + 
今回は、プロファイラについてのお話をのせたいと思います。 +

弊社、矢ヶ崎もPHPプロファイルについて触れてますので興味のある方はどうぞ！
http://tech.innovation.co.jp/2018/07/30/P-H-P.html


====== 事前準備
Goの標準ライブラリのpprofを使うため、特別な準備はありません。


====== 使用するプログラム
現在、製造中のプラグラムを使用しました。 +
Azureのキューストレージからデータを取得し、チェック処理後にDBにInsertするバッチ処理です。 

今回は、CpuProfile情報を取得してみます。 + 


使い方は簡単。 +
CpuProfile情報を出力するファイルを生成 +

計測開始時にStartCPUProfile(f) を実行。 +

計測終了時にStopCPUProfile()を実行。 +

これだけです。main関数の最初に追記しました。


++++
<pre style="font-family: Menlo, Courier">
f, _ := os.Create("test.profile")
pprof.StartCPUProfile(f)
defer pprof.StopCPUProfile()
</pre> 
++++


====== プロファイルデータの取得

・Goの実行モジュール（バッチアプリケーション）を生成します。

++++
<pre style="font-family: Menlo, Courier">
go install /**/sample
</pre> 
++++

・バッチ実行

++++
<pre style="font-family: Menlo, Courier">
. ./sample
</pre> 
++++

・バッチ実行後 +
同じディレクトリにtest.profileファイルが出力されます。


++++
<pre style="font-family: Menlo, Courier">
-rwxr-xr-x 1 root root 12446598 Sep  8 12:48 sample
-rw-r--r-- 1 root root    19163 Sep  8 15:27 test.profile
</pre> 
++++

====== プロファイルの解析！
それでは、見てみましょう。 +

以下のコマンドを実行。
++++
<pre style="font-family: Menlo, Courier">
go tool pprof sample test.profile
</pre> 
++++

どん！

++++
<pre style="font-family: Menlo, Courier">
File: sample
Type: cpu
Time: Sep 8, 2018 at 3:23pm (JST)
Duration: 4.17mins, Total samples = 1.81s ( 0.72%)
Entering interactive mode (type "help" for commands, "o" for options)
(pprof)
</pre> 
++++
(pprof)プロンプトの入力待ちになりました。 +


・topコマンド実行
++++
<pre style="font-family: Menlo, Courier">
(pprof) top
Showing nodes accounting for 1130ms, 62.43% of 1810ms total
Showing top 10 nodes out of 407
      flat  flat%   sum%        cum   cum%
     370ms 20.44% 20.44%      410ms 22.65%  syscall.Syscall
     270ms 14.92% 35.36%      270ms 14.92%  runtime._ExternalCode
     160ms  8.84% 44.20%      160ms  8.84%  runtime.usleep
     110ms  6.08% 50.28%      110ms  6.08%  runtime.futex
      60ms  3.31% 53.59%       60ms  3.31%  runtime.memmove
      40ms  2.21% 55.80%       40ms  2.21%  runtime.epollwait
      30ms  1.66% 57.46%       30ms  1.66%  runtime.epollctl
      30ms  1.66% 59.12%       30ms  1.66%  runtime.getitab
      30ms  1.66% 60.77%       30ms  1.66%  runtime.heapBitsSetType
      30ms  1.66% 62.43%       90ms  4.97%  runtime.mallocgc
</pre> 
++++

・top -cumコマンド実行
++++
<pre style="font-family: Menlo, Courier">
(pprof)top -cum
Showing nodes accounting for 0.65s, 35.91% of 1.81s total
Showing top 10 nodes out of 407
      flat  flat%   sum%        cum   cum%
         0     0%     0%      0.65s 35.91%  main.mainProcess
         0     0%     0%      0.42s 23.20%  main.businessProcess
     0.37s 20.44% 20.44%      0.41s 22.65%  syscall.Syscall
         0     0% 20.44%      0.30s 16.57%  github.com/innovation-jp/list-finder-batch/application/tracking/logic.InsertAccessLogData
         0     0% 20.44%      0.28s 15.47%  runtime._System
     0.27s 14.92% 35.36%      0.27s 14.92%  runtime._ExternalCode
     0.01s  0.55% 35.91%      0.25s 13.81%  github.com/innovation-jp/list-finder-batch/vendor/github.com/jinzhu/gorm.(*Scope).callCallbacks
         0     0% 35.91%      0.23s 12.71%  net.(*Resolver).goLookupIPCNAMEOrder.func1
         0     0% 35.91%      0.23s 12.71%  net.(*Resolver).tryOneName
         0     0% 35.91%      0.22s 12.15%  net.(*Resolver).exchange

</pre> 
++++

・peekコマンド実行
++++
<pre style="font-family: Menlo, Courier">
(pprof) peek main.
Showing nodes accounting for 1.81s, 100% of 1.81s total
----------------------------------------------------------+-------------
      flat  flat%   sum%        cum   cum%   calls calls% + context
----------------------------------------------------------+-------------
                                             0.01s   100% |   net.packStruct.func1
     0.01s  0.55%  0.55%      0.01s  0.55%                | net.packDomainName
----------------------------------------------------------+-------------
                                             0.09s   100% |   github.com/innovation-jp/list-finder-batch/library/common.ExistTargetClient
         0     0%  0.55%      0.09s  4.97%                | github.com/innovation-jp/list-finder-batch/library/database/postgres/masters.(*ClientDomainDB).FindContractClientByTrackingID
                                             0.09s   100% |   github.com/innovation-jp/list-finder-batch/vendor/github.com/jinzhu/gorm.(*DB).Scan
----------------------------------------------------------+-------------
                                             0.42s   100% |   main.mainProcess
         0     0%  0.55%      0.42s 23.20%                | main.businessProcess
                                             0.30s 71.43% |   github.com/innovation-jp/list-finder-batch/application/tracking/logic.InsertAccessLogData
                                             0.09s 21.43% |   github.com/innovation-jp/list-finder-batch/library/common.ExistTargetClient
                                             0.03s  7.14% |   github.com/innovation-jp/list-finder-batch/application/tracking/logic.SetRequestData
----------------------------------------------------------+-------------
         0     0%  0.55%      0.65s 35.91%                | main.mainProcess
                                             0.42s 64.62% |   main.businessProcess
                                             0.14s 21.54% |   github.com/innovation-jp/list-finder-batch/library/common.AzureStorageQueueClient.GetStorageQueues
                                             0.04s  6.15% |   github.com/innovation-jp/list-finder-batch/library/common.AzureStorageQueueClient.DeleteStorageQueues
                                             0.02s  3.08% |   encoding/json.Unmarshal
                                             0.02s  3.08% |   html.UnescapeString
                                             0.01s  1.54% |   github.com/innovation-jp/list-finder-batch/vendor/github.com/cihub/seelog.(*commonLogger).Debug
----------------------------------------------------------+-------------
                                             0.01s   100% |   net.unpackStruct.func1
         0     0%  0.55%      0.01s  0.55%                | net.unpackDomainName
                                             0.01s   100% |   runtime.concatstring3
----------------------------------------------------------+-------------

</pre> 
++++

・listコマンド実行
関数名をパラメタに指定できます。今回はmainを指定しました。 +
プログラムのステップ毎に実行時間が出力されます。 +
数値が２つ出力されていますが、左はその関数自体の実行時間、右はその行で呼んでいる関数の実行時間も合わせた実行時間になります。
