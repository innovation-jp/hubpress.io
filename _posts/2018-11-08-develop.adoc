= developが更新されたらお知らせしてくれるシェルスクリプトを作りたい！
:hp-tags: sumomo, ShellScript, Git, Linux


こんにちは、未経験中途エンジニアのすももです。 +
入社してなんだかんだ1年経ちました〜、本当にあっという間ですね。 +
出来る事が増えた喜びと、まだまだ何も出来ない哀しみの狭間で生きてます。 +
...とはいえ元気ですのでご心配なく！笑
 +
 +


今回のテーマは「developが更新されたらお知らせしてくれるシェルスクリプトを作る！」 +
ということで。 +

*〜なぜ作るのか？〜* +
私のチームでは、リリースでdevelopを更新した際、メンバーに口頭やSlackで「昨日リリースあったので、developをマージお願いいたします！」と伝えてたりするのですが、言う方も言われた方も忘れてしまうことが多く・・・。笑 +
「コミットする時とかにdevelopと差分あったら教えてくれるようにしたいね！」という話になりました〜 +
 +
そして、ちょうどシェルスクリプトの勉強を少ししたところだったので、私が挑戦してみることに！


*〜今回作りたいもの〜* +
・コミットしようとするとシェルスクリプトが動く +
・作業ブランチとdevelopに差分があったらメッセージが出る +
・差分がある場合はコミットするかしないか選べる +

*〜完成したもの〜* +

image::/images/sumomo/20181108/1.png[]

image::/images/sumomo/20181108/2.png[]

*〜やったこと〜* +
#*1.Gitディレクトリのhooksサブディレクトリに「pre-commit」ファイルを作成*# 
```
$ vi .git/hooks/pre-commit
```
<Gitフックについてはこちらを参考にしました> +
https://git-scm.com/book/ja/v1/Git-%E3%81%AE%E3%82%AB%E3%82%B9%E3%82%BF%E3%83%9E%E3%82%A4%E3%82%BA-Git-%E3%83%95%E3%83%83%E3%82%AF

・スプレッドシートを開いたら、メニューにある「ツール」をクリック +
・上から２番目「スクリプトエディタ」という表示があるのでクリック +

image::/images/sumomo/20180502/1.png[]

よし、スクリプトエディタが開いたぞ！ +
 +
 
#*2.コードの編集*# 

・初期状態ではmyFunctionという関数が書かれているので、関数名を変えたり中身のコードを書いてみる +

```
function test() {
  // スプレッドシートを開いた時にメッセージダイアログを表示する
  Browser.msgBox('テスト');
}

```

* 注意点！ +
スプレッドシートは自動保存だが、スクリプトエディタは自動保存されないので、都度手動で保存が必要 +
（編集が保存されてない時は「コード.gs」の前に赤いアスタリスクマークが出ます）


#*3.試しに実行してみよう！*#

・スクリプトエディタのメニューからプルダウンで関数名選ぶ + 
（コード保存すると勝手に関数名のプルダウンに反映する） +
・「▶」(実行ボタン)を押すとGASが実行される +

* 注意点！ +
初回実行時は「承認が必要です」というダイアログが出る為、「許可を確認」をクリック +
↓
 +
次の画面でGoogleアカウントを選択 + 
↓
 +
最後に「許可」をクリックすると承認される +

image::/images/sumomo/20180502/2.png[]

わーい、実行できたー！ +
 +

##### GAS実行の準備ができたので +
##### さっそく作ってみよう！

#*今回作りたいもの*# +
毎日スプレッドシートを見ながら、BLチェックという作業をするのですが、朝一やらないとやり忘れることがある...！ +
...なので、やり忘れていたら決まった時間にslackでお知らせしてほしい〜 +


#*お知らせ(slack)を送るまでの流れ*# +
　①スプレッドシート編集時に今日の日付を書き込む +
　②指定した時間に、シートに書き込まれている日付をチェックする +
　③書き込まれている日付が今日の日付でなければslackを送る +
　④送信先のslackbotにお知らせが届く +


*①-1.スプレッドシート編集時に今日の日付を書き込む（準備）*

```
// 現在の日時を取ってくる
var today = new Date();

// 紐づいているファイル自体をとってくる！
var ss = SpreadsheetApp.getActiveSpreadsheet();

// 指定した名前のシートをとってくる(今回欲しいのは「2018年5月」という名前のシート)
var sheet = ss.getSheetByName(today.getFullYear() + '年' + (today.getMonth() + 1) + '月');

// 指定したセルそのものを取ってくる！
var cell = sheet.getRange('C1');

// 日付のみ入れる(2018年5月1日というような感じで)
var date = today.getFullYear() + '年' + (today.getMonth() + 1) + '月' + today.getDate() + '日';

```


*①-2.スプレッドシート編集時に今日の日付を書き込む*

```
// 日付を書き込む関数を作る（トリガーをスプレッドシート編集時に実行するよう設定）
function input_date() {
  // date(今日の日付)をcell(C1)に入れる
  cell.setValue(date);
}

```

トリガーの設定はスクリプトエディタのメニューにある「時計マークのボタン」→「新しいトリガーを追加」から行えます。 +

image::/images/sumomo/20180502/3-1.png[]

シートを編集したら日付が入力された！ +
 +

*②-1.指定した時間に、シートに書き込まれている日付をチェックする（準備）*

```
// cell(C1)にセットされている値(日付)を取ってくる
var value = cell.getValue();
```


*③-1.書き込まれている日付が今日の日付でなければslackを送る（準備）*

```
// slackのトークンを入れておく
var token = 'xoxp-XXXXXXXX-XXXXXXXX-XXXXX';

// slackAppインスタンスを取得
var slackApp = SlackApp.create(token);

// slackのユーザー名を入れておく（slackの表示名ではなくユーザー名の方！）
var my_slackbot = '@XXXX';

// slack送信時のタイトルを入れておく
var bot_title = 'すももよりお知らせ';

// slack送信時の画像URLを入れておく（「FLAT ICON DESIGN」さんの画像をアイコンとして利用しています）
var icon_url = 'アイコンのURL';

```

Slackへの通知に関しては、以下サイトを参考にGASのライブラリを使用いたしました。 +
https://qiita.com/soundTricker/items/43267609a870fc9c7453 +
ライブラリの登録はスクリプトエディタのメニューにある「リソース」→「ライブラリ」→「ライブラリを追加」から行えます。 +

* 注意点！ +
slackのユーザー名は、いつも見ている表示名とは違う場合があります！ +
「プロフィール＆アカウント」→「アカウント設定」→「ユーザー名」→「開く」から確認できます。 +
この事に気付くまで、「slack送れる人と送れない人がいる！なんで？？」となりました...


*②-2.指定した時間に、シートに書き込まれている日付をチェックする* +
*③-2.書き込まれている日付が今日の日付でなければslackを送る*

```
// slackを送る関数を作る（トリガーから実行時間を指定）
function send_slack() {
  // もしvalue(入力されてる日付)がdate(今日の日付)と違っていたら
  if (value !== date) {
    // my_slackbot(すもものslackbot)にメッセージを送信する
    slackApp.postMessage(my_slackbot, "まだBLチェックやってないよー！",
                         {
                           username : bot_title,
                           icon_url : icon_url
                         });
  }
}

```


*④送信先のslackbotにお知らせが届く*

指定時間までシートが編集されず、入力されている日付が今日の日付じゃないと...？

image::/images/sumomo/20180502/4.png[]

slackきたー！！！！ +



##### 感想

GASはプログラミング初心者の私でもとっつきやすかったので、今後もいろいろ試してみたいなー！と思いました。 +
 +
〜おしまい〜 +


