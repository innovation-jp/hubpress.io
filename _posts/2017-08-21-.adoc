# コミットメッセージをチェックするスクリプト書いてみた
:hp-alt-title:　コミットメッセージをチェックするスクリプト書いてみた
:hp-tags: Obata, ShellScript

初めまして、今年新卒でエンジニアに配属されました小畑です。 +

プログラミングとしては、CとかJavaとかアセンブリ言語とかを軽く勉強した程度で +
わりと初心者に近い人です。

そんな私が、ブログ記事・・・これは先輩のブログ記事を参考にするしかない！ +
そう思っていい記事ないかなと見ていたら、先輩のこんな良い記事が。


## コミットメッセージミスを防いでみよう！
> キャッシュについて深く反省してみる... +
> http://tech.innovation.co.jp/2017/07/31/to-reflect-on-the-cache.html

この記事の後半、シェルスクリプトで問題を見つけたらアラートを表示する。 +

これだ！！！ +

最近gitでcommitをする時につけるメッセージを間違えてしまいます。 +
正しいものは下のメッセージです。
++++
<pre style="font-family: Menlo, Courier">
$ git commit -m "テスト！" 　　　　#☓正しくない
$ git commit -m "LF-22 テスト！"　#◯正しい
</pre>
++++


これを判定するプログラムをシェルスクリプトで書いてみました！ +
その勉強の軌跡も書きますので、シェルスクリプトでそんな書き方あるんだ！って気づきになれば幸いです！ +


### 作ったもの

++++
***/.git/config
<pre style="font-family: Menlo, Courier">
[alias]
        cmt = cmt-c
</pre>

git-cmt-c
<pre style="font-family: Menlo, Courier">
#!/bin/bash
command='git commit -m'
comment='"'$1'"'

#引数が条件にあっていればコマンドを実行
#条件にあっていなければ、LF-**を追加して、コマンド実行許可をもらう
if [ "`echo $1 | grep -e "^LF-.* .*$"`" ]; then
  echo $command' '$comment
  eval $command' '$comment
else
  number="`git rev-parse --abbrev-ref HEAD | sed -E "s/.*\/(.*)$/\1/"`"
  comment='"'LF-$number' '$1'"'

  echo $command' '$comment' OK?(y/n)'
  read ans
  case $ans in
    [Yy] )
      eval $command' '$comment ;;
    * )
      echo 'exit' ;;
  esac
fi
</pre>
++++
------------------------------------------------------ +
実行結果 +
------------------------------------------------------ +
++++
<pre style="font-family: Menlo, Courier">
$ git cmt "LF-54 テスト"     #正しいのでコミットする
git commit -m "LF-54 テスト"
~~いろいろ書かれて~~
1 file changed, 1 insertion(+)

$ git cmt <font color=red>"テスト"</font>             #コメント付け足してコミットする
git commit -m <font color=red>"LF-707 テスト"</font> OK?(y/n)
y
~~いろいろ書かれて~~
1 file changed, 1 insertion(+)

$ git cmt "テスト"             #コミットしない
git commit -m "LF-707 テスト" OK?(y/n)
n
exit
</pre>
++++

### Step1 メッセージの条件を確かめよう

/usr/local/binにgit-cmt-cというファイルを作成します。 +
git commit check的な意味合いでこの名前にしました！ +

まずは条件の判断が出来るかチェックします +
１．引数$1をechoでgrepに投げます。  +
２．grepで条件を正規表現でチェック！

++++
<pre style="font-family: Menlo, Courier">
#!/bin/bash
#引数が"LF-**[スペース]"で始まるなら引数をそのまま出力
echo $1 | grep -e "^LF-.* "
</pre>

実行結果
<pre style="font-family: Menlo, Courier">
$ git-cmt-c "LF-22tes"
<font color=red>  何も出力されない </font>

$ git-cmt-c "LF-22 tes"
LF-22 tes
</pre>
++++


### Step2 if文に入れてメッセージを表示しよう

ここで一つ問題が出てきました。 +
先程の文をif文にそのまま入れると +
if [ echo $1 | grep -e "^LF-.* " ]; then + 
出力結果を考えると +
if [ LF-22 tes ]; then +
このように、スペース混じりの文字列が出力されるので、 +
スペースで区切られた文字は別々の文字と判断されてしまいます。 +
そこで、以下の手順を踏みました。

1．""で囲むことで、出力されるスペース混じりの文字列を一つにまとめる +
2．if文内ではコマンドの実行結果を判定したいので、 +
　 ``で囲むことで文字列ではなくコマンドの実行結果を取得する +


++++
<pre style="font-family: Menlo, Courier">
#!/bin/bash
#引数が条件にあっているかチェック
if [ "`echo $1 | grep -e "^LF-.* "`" ]; then
  echo "ばっちり！"
else
  echo "先頭にkeyがついてないよ！"
fi
</pre>

実行結果
<pre style="font-family: Menlo, Courier">
$ git-cmt-c "LF-22tes"
先頭にkeyがついてないよ！

$ git-cmt-c "LF-22 tes"
ばっちり！
</pre>
++++


### Step3 エイリアスを設定しよう

このコマンドは、自社サービスのプログラムを触る時にだけ使いたいので、
対象のgitのディレクトリ内.git/configにちょっと追記をします。

++++
***/.git/config
<pre style="font-family: Menlo, Courier">
[alias]
        cmt = cmt-c
</pre>
++++



### Step4 正しい時はコミットしよう！

1.実行したいコマンドを記述 +
2.引数を""で囲みながらコマンドに結合 +
3.evalで実行！ +

++++
git-cmt-c
<pre style="font-family: Menlo, Courier">
#!/bin/bash
command="git commit -m"
comment='"'$1'"'

#引数が条件にあっていればコマンドを実行
if [ "`echo $1 | grep -e "^LF-.* .*$"`" ]; then
  eval $command' '$comment
else
  echo "先頭にkeyがついてないよ！"
fi
</pre>

実行結果
<pre style="font-family: Menlo, Courier">
$ git cmt "test"           #コミットしない
先頭にkeyがついてないよ！

$ git cmt "LF-123 test"    #コミットする
LF-123 test
~~いろいろ書かれてて~~
1 file changed, 1 insertion(+)
</pre>
++++

### Step5 自動でコメント追加して、実行許可をもらう

ここまででも十分ですが、せっかくなら自動でコメント追加してみましょう。 +
私達が行ってるプロジェクトでは、ブランチ名feature/◯◯/123の123部分が コメントに必要なので、 +
番号だけ抜き出し、コメントに追加します。 +

1.git rev-parseでブランチ名取得 +
2.sedでブランチ名から数値だけを取得して、コメントに追加 +
3.read caseでyの時だけコマンド実行 +

++++
<pre style="font-family: Menlo, Courier">
#!/bin/bash
command='git commit -m'
comment='"'$1'"'

#引数が条件にあっていればコマンドを実行
#条件にあっていなければ、LF-**を追加して、コマンド実行許可をもらう
if [ "`echo $1 | grep -e "^LF-.* .*$"`" ]; then
  echo $command' '$comment
  eval $command' '$comment
else
  number="`git rev-parse --abbrev-ref HEAD | sed -E "s/.*\/(.*)$/\1/"`"
  comment='"'LF-$number' '$1'"'

  echo $command' '$comment' OK?(y/n)'
  read ans
  case $ans in
    [Yy] )
      eval $command' '$comment ;;
    * )
      echo 'exit' ;;
  esac
fi
</pre>

実行結果
<pre style="font-family: Menlo, Courier">
$ git cmt "LF-54 テスト"     #正しいのでコミットする
git commit -m "LF-54 テスト"
~~いろいろ書かれて~~
1 file changed, 1 insertion(+)

$ git cmt "テスト"             #コミットする
git commit -m "LF-707 テスト" OK?(y/n)
y
~~いろいろ書かれて~~
1 file changed, 1 insertion(+)

$ git cmt "テスト"             #コミットしない
git commit -m "LF-707 テスト" OK?(y/n)
n
exit
</pre>
++++

## まとめ
■使ったコマンド +

- grep -eで条件一致を探す
- "" でくくって空行混じりの文字列対策
- evalで実行
- sedで条件文字列を抜き出し
- read caseでユーザーにコマンドを求める


そして偉大なる先輩に敬礼(｀･ω･´)ゞ +
ここまで読んでくださった方、ありがとうございました！ +

## おまけ
### gitのhooksを使って、コミットメッセージを書き換える（シェルスクリプト編）

イノベーションの上司である、加藤大先生からもう一つ便利なものを教えていただきました。 +

gitには特定の処理の後に、さらに処理を追加することが出来ます。 +
今回は.git/hooks内のcommit-msgに先程作った処理を応用して追加します。 +
記事を探してみたけれど、どれもRubyの記事だったので自力で書いてみました。 +

1.ファイルの中身を比較するためにcatの出力結果を使う +
2.新しいメッセージをCOMMIT_EDITMSGに出力することでコメント内容を上書きする +

注意点が一点あります。 +
$1に来るのは.git/COMMIT_EDITMSGというコミットメッセージが書かれたファイルのパスです。 +
catを$1に利用することで、コミットメッセージを取り出すことが出来ます。

++++
***/.git/hooks/commit-msg
<pre style="font-family: Menlo, Courier">
#!/bin/bash
#.git/COMMIT_EDITMSGが条件にあっていればコマンドを実行
#条件にあっていなければ、メッセージにLF-**を追加して、コマンドを行う
if [ "`cat $1 | grep -e "^LF-.* .*$"`" ]; then
  echo "OK"
else
  number="`git rev-parse --abbrev-ref HEAD | sed -E "s/.*\/(.*)$/\1/"`"
  comment=LF-$number" "`cat $1`
  echo $comment>$1
  echo "change commit massage: "$comment
fi
</pre>
実行結果
<pre style="font-family: Menlo, Courier">
$ git commit -m "LF-123 test test2"
OK
~~いろいろ書かれて~~
1 file changed, 1 insertion(+)
 
$ git reset --soft HEAD^
$ git commit -m "test test2"
change commit massage: LF-702 test test2
~~いろいろ書かれて~~
1 file changed, 1 insertion(+)


$ git log
~~いろいろ書かれて~~
Date:   Tue Aug 22 14:49:25 2017 +0900

    LF-702 test test2
</pre>
++++

あれ・・・？これもしかしてStep3とStep4要らなかったのではないでしょうか・・・？ +
ちゃんと調べるって大切ですね・・・ +

でも！教えていただける環境に感謝です！ 少しは成長出来たのかな？ +
最後まで読んでくださった方、改めてありがとうございました！ +