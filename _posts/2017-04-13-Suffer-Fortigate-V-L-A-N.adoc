
# FortigateのVLAN設定に苦しんだ話
:published_at: 2017-04-13
:hp-alt-title: Suffer Fortigate VLAN
:hp-tags: Network, Fortigate, VLAN, KTN

KTNです。 +
弊社では最新技術に触れるために新しいデバイスや、アイテムを導入しています。 +
それと一緒に！？社内のネットワークをパワーアップさせたい！ということで、 +
ネットワーク機器も購入しました。 +
なので、今回はそれをご紹介したいと思います。 +

## 何に使うの？
現在社内に無線のAPが何台か設置されてまして、 +
社内ネットワーク専用のSSIDが作成されていますが、 +
既存のSSIDとは別に、インターネット専用のSSIDを作成したい。 +
そして、SSIDの接続情報を会議室等に書いておけば、 +
お客様が弊社にいらっしゃった際に、自由にご利用いただけて便利なはず！！ +
ということで今回機器を購入しました。 +

image::kotani/20170413/1.jpg[]

並べてみました！

## どんな構成にするか





## FortigateでVLAN
ということで、Fortigate 50E（以下Fortigate）のVLAN設定をしていきます。 + 
電源ONして、PCとFortigateのLAN1を接続します。 +

image::kotani/20170413/2.jpg[]

リンクアップして1がピカピカしてます。 +

image::kotani/20170413/4.png[]

MACのネットワーク画面を確認すると、 +
DHCPでIPとゲートウェイ（画面項目：ルーター）が取得出来ています。 +

ブラウザを開いて、 +
https://192.168.1.99/ +
にアクセスすると、 +

image::kotani/20170413/5.png[]

管理画面が出てきました。とっても簡単！ + 
デフォルト設定は + 
　User Name：admin +
　Password：（なし） +
になります。 + 

image::kotani/20170413/6.png[]

ログインしました。

image::kotani/20170413/7.png[]

設定画面にログインして、左ペイン？（とマニュアルでは呼ぶようです）から、 +
Network - Interfaces を開きます。 +


lanポートがスイッチモードになっているようで、1~5がひとつのグループになってます。 +
今回は、 +
　lan1：社内ネットワーク（VLAN100） +
　lan2：インターネット専用ネットワーク（VLAN200） +
　lan3：スイッチと接続（タグVLAN） +
という感じに設定したいので、 +
lanポートをバラバラで使うインタフェースモードに変えたいと思います。 +
 +
マニュアルを見ると、 +
CLIから設定する必要があるようなので、 +
Dashboard を開いて、CLI Console を使います。 +
❏画像

```
# config system global

(global) # set internal-switch-mode interface

command parse error before 'internal-switch-mode'
Command fail. Return code -61
```

インターネットで調べたコマンドを発行してみたのですが、 +
そんなコマンド知らないと言われてしまいました。 +
Interfaces 画面から出来るのか？と探してみると、 +
以下の感じで出来ることがわかりました。 +
 +
続いてVLANインタフェースを作ってみます。 +
設定は以下の通りです。 +

```
■lan1の設定
　VLAN ID：100
　　Interface：lan1
　　IP：192.168.12.1/255.255.255.0

■lan2の設定
　VLAN ID：200
　　Interface：lan2
　　IP：192.168.13.1/255.255.255.0

■lan3の設定
　VLAN ID：100
　　Interface：lan3

　VLAN ID：200
　　Interface：lan3
```

設定するとこんな感じになります。 +
これで設定OKなはずなので、動作確認をしてみます。 +
PCをlan1に接続して、IPを固定で設定して、 +
https://192.168.12.1/ にアクセスすると、 +
管理画面が出てきま・・・・・・せんでした。 +
 +
実は設定中も違和感がありまして、 +
lan3にVLAN100を割り当てる際に、 +

```
This name is already in use by another interface.
```

というエラーメッセージが出たので、 +
VLAN100-TRUNKという名前にしてとりあえず登録してみました。 +
そもそもこんなエラーになるということは、 +
設定の仕方自体に誤りがある気がして、 +
マニュアル様を確認することにしました。 +
※マニュアルはFortigateさんのホームページから、 +
　アカウント登録する必要があります。 +
 +
マニュアル確認すると、 +
VLANインタフェースはタグVLANを使う時だけ設定するようで、 +
そもそも想定していた以下の構成では設定はできないようです。 +
 +

なるほど〜、ということで以下の構成にすることにしました。

```
interface GigabitEthernet0/1
 switchport access vlan 100

interface GigabitEthernet0/24
 switchport mode trunk

interface Vlan100
 no ip address
 no ip route-cache

interface Vlan200
 no ip address
 no ip route-cache
```

すると、通信ができました！！
結果は以下のとおりです。

```
$ ping 192.168.12.1
PING 192.168.12.1 (192.168.12.1): 56 data bytes
64 bytes from 192.168.12.1: icmp_seq=0 ttl=255 time=0.629 ms
64 bytes from 192.168.12.1: icmp_seq=1 ttl=255 time=0.540 ms
64 bytes from 192.168.12.1: icmp_seq=2 ttl=255 time=0.603 ms
64 bytes from 192.168.12.1: icmp_seq=3 ttl=255 time=0.539 ms
64 bytes from 192.168.12.1: icmp_seq=4 ttl=255 time=0.581 ms
--- 192.168.12.1 ping statistics ---
5 packets transmitted, 5 packets received, 0.0% packet loss
round-trip min/avg/max/stddev = 0.539/0.578/0.629/0.035 ms
```

## やっとFortigateの気持ちになれた！？









