<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <title>LINEとLambdaでパンケーキ！ なお話 - イノベーション　エンジニアブログ</title>

    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <meta name="description" content="">

    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="LINEとLambdaでパンケーキ！ なお話">
    <meta name="twitter:description" content="">

    <meta property="og:type" content="article">
    <meta property="og:title" content="LINEとLambdaでパンケーキ！ なお話">
    <meta property="og:description" content="">

    <link href="/favicon.ico" rel="shortcut icon" type="image/x-icon">
    <link href="/apple-touch-icon-precomposed.png" rel="apple-touch-icon">
    
<script type="text/javascript">
var _trackingid = 'LFT-10003-1';

(function() {
  var lft = document.createElement('script'); lft.type = 'text/javascript'; lft.async = true;
  lft.src = document.location.protocol + '//test.list-finder.jp/js/ja/track_test.js';
  var snode = document.getElementsByTagName('script')[0]; snode.parentNode.insertBefore(lft, snode);
})();
</script>

<script type="text/javascript">
var _trackingid = 'LFT-10003-1';

(function() {
  var lft = document.createElement('script'); lft.type = 'text/javascript'; lft.async = true;
  lft.src = document.location.protocol + '//track.list-finder.jp/js/ja/track_prod_wao.js';
  var snode = document.getElementsByTagName('script')[0]; snode.parentNode.insertBefore(lft, snode);
})();
</script>

    <link rel="stylesheet" type="text/css" href="//tech.innovation.co.jp/themes/uno/assets/css/uno.css?v=1.0.0" />

    <link rel="canonical" href="http://tech.innovation.co.jp/2017/04/14/Azure-3.html" />
    
    <meta property="og:site_name" content="イノベーション　エンジニアブログ" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="LINEとLambdaでパンケーキ！ なお話" />
    <meta property="og:description" content="お久しぶりです、SREと呼ぶ方も呼ばれる方もまだ慣れていない syoga です。 最近 SRE というチーム名に恥じない業務をするには何をすべきか… DevOpsってなんでも自動化するだけじゃないよね…等 日々の業務について悶々としていたところ、ドラゴンクエストXIの発売日が決まりました！！ 3DSとPS4 というマルチ展開なのでとりあえず両方購入する事にします！ Azure Machine Learning のお話 その3 Azure シリーズの第3段となります、前回までのあらすじはこちらです。 機械学習を学ぶため Azure Machin Trai..." />
    <meta property="og:url" content="http://tech.innovation.co.jp/2017/04/14/Azure-3.html" />
    <meta property="article:published_time" content="2017-04-13T15:00:00.000Z" />
    <meta property="article:modified_time" content="2017-04-16T07:50:30.544Z" />
    <meta property="article:tag" content="syoga" />
    <meta property="article:tag" content="log" />
    <meta property="article:tag" content="Azure" />
    <meta property="article:tag" content="Computer Vision API" />
    <meta property="article:tag" content="Node.js" />
    <meta property="article:tag" content="AWS" />
    <meta property="article:tag" content="Lambda" />
    <meta property="article:tag" content="LINE" />
    
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="LINEとLambdaでパンケーキ！ なお話" />
    <meta name="twitter:description" content="お久しぶりです、SREと呼ぶ方も呼ばれる方もまだ慣れていない syoga です。 最近 SRE というチーム名に恥じない業務をするには何をすべきか… DevOpsってなんでも自動化するだけじゃないよね…等 日々の業務について悶々としていたところ、ドラゴンクエストXIの発売日が決まりました！！ 3DSとPS4 というマルチ展開なのでとりあえず両方購入する事にします！ Azure Machine Learning のお話 その3 Azure シリーズの第3段となります、前回までのあらすじはこちらです。 機械学習を学ぶため Azure Machin Trai..." />
    <meta name="twitter:url" content="http://tech.innovation.co.jp/2017/04/14/Azure-3.html" />
    
    <script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Article",
    "publisher": "イノベーション　エンジニアブログ",
    "author": {
        "@type": "Person",
        "name": null,
        "image": "https://avatars0.githubusercontent.com/u/20530620?v=3",
        "url": "undefined/author/undefined",
        "sameAs": null
    },
    "headline": "LINEとLambdaでパンケーキ！ なお話",
    "url": "http://tech.innovation.co.jp/2017/04/14/Azure-3.html",
    "datePublished": "2017-04-13T15:00:00.000Z",
    "dateModified": "2017-04-16T07:50:30.544Z",
    "keywords": "syoga,  log,  Azure,  Computer Vision API,  Node.js,  AWS,  Lambda,  LINE",
    "description": "お久しぶりです、SREと呼ぶ方も呼ばれる方もまだ慣れていない syoga です。 最近 SRE というチーム名に恥じない業務をするには何をすべきか… DevOpsってなんでも自動化するだけじゃないよね…等 日々の業務について悶々としていたところ、ドラゴンクエストXIの発売日が決まりました！！ 3DSとPS4 というマルチ展開なのでとりあえず両方購入する事にします！ Azure Machine Learning のお話 その3 Azure シリーズの第3段となります、前回までのあらすじはこちらです。 機械学習を学ぶため Azure Machin Trai..."
}
    </script>

    <meta name="generator" content="Ghost ?" />
    <link rel="alternate" type="application/rss+xml" title="イノベーション　エンジニアブログ" href="http://tech.innovation.co.jp/rss" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/default.min.css">


</head>
<body class="post-template tag-syoga tag-log tag-Azure tag-Computer-Vision-A-P-I tag-Nodejs tag-A-W-S tag-Lambda tag-L-I-N-E no-js">

    <span class="mobile btn-mobile-menu">
        <i class="icon icon-list btn-mobile-menu__icon"></i>
        <i class="icon icon-x-circle btn-mobile-close__icon hidden"></i>
    </span>

    <header class="panel-cover panel-cover--collapsed " >
      <div class="panel-main">
    
        <div class="panel-main__inner panel-inverted">
        <div class="panel-main__content">
    
            <h1 class="panel-cover__title panel-title"><a href="http://tech.innovation.co.jp" title="link to homepage for イノベーション　エンジニアブログ">イノベーション　エンジニアブログ</a></h1>
            <hr class="panel-cover__divider" />
            <p class="panel-cover__description">株式会社イノベーションのエンジニアたちの技術系ブログです</p>
            <hr class="panel-cover__divider panel-cover__divider--secondary" />
    
            <div class="navigation-wrapper">
    
              <nav class="cover-navigation cover-navigation--primary">
                <ul class="navigation">
                  <li class="navigation__item"><a href="http://tech.innovation.co.jp/#blog" title="link to イノベーション　エンジニアブログ blog" class="blog-button">Blog</a></li>
                </ul>
              </nav>
    
              
              
              <nav class="cover-navigation navigation--social">
                <ul class="navigation">
              
              
              
              
              
              
              
              
              
              
                </ul>
              </nav>
              
    
            </div>
    
          </div>
    
        </div>
    
        <div class="panel-cover--overlay"></div>
      </div>
    </header>

    <div class="content-wrapper">
        
    	<!-- ソーシャルボタンここから -->
    	<div id="boxArea" style="display: table; padding: 0 0 0 2px;">
    		<div style="width: 74px; height: 22px; float: left;">
    			<a href="https://twitter.com/share" class="twitter-share-button"
    				{count} data-lang="ja" data-dnt="true">ツイート</a>
    			<script>
    				!function(d, s, id) {
    					var js, fjs = d.getElementsByTagName(s)[0], p = /^http:/
    							.test(d.location) ? 'http' : 'https';
    					if (!d.getElementById(id)) {
    						js = d.createElement(s);
    						js.id = id;
    						js.src = p + '://platform.twitter.com/widgets.js';
    						fjs.parentNode.insertBefore(js, fjs);
    					}
    				}(document, 'script', 'twitter-wjs');
    			</script>
    		</div>
    		<div style="width: 76px; height: 22px; float: left;">
    			<div class="g-plusone" data-size="medium"></div>
    			<script type="text/javascript">
    				window.___gcfg = {
    					lang : 'ja'
    				};
    				(function() {
    					var po = document.createElement('script');
    					po.type = 'text/javascript';
    					po.async = true;
    					po.src = 'https://apis.google.com/js/platform.js';
    					var s = document.getElementsByTagName('script')[0];
    					s.parentNode.insertBefore(po, s);
    				})();
    			</script>
    		</div>
    		<div style="width: 126px; height: 22px; float: left;">
    			<a href="http://b.hatena.ne.jp/entry/" class="hatena-bookmark-button"
    				data-hatena-bookmark-layout="standard-balloon"
    				data-hatena-bookmark-lang="ja" title="このエントリーをはてなブックマークに追加"><img
    				src="http://b.st-hatena.com/images/entry-button/button-only@2x.png"
    				alt="このエントリーをはてなブックマークに追加" width="20" height="20"
    				style="border: none;" /></a>
    			<script type="text/javascript"
    				src="http://b.st-hatena.com/js/bookmark_button.js" charset="utf-8"
    				async="async"></script>
    		</div>
    		<div style="width: 117px; height: 22px; float: left;">
    			<a data-pocket-label="pocket" data-pocket-count="horizontal"
    				class="pocket-btn" data-lang="en"></a>
    		</div>
    		<div style="width: 86px; height: 22px; float: left;">
    			<span><script type="text/javascript"
    					src="//media.line.me/js/line-button.js?v=20140411"></script>
    				<script type="text/javascript">
    					new media_line_me.LineButton({
    						"pc" : true,
    						"lang" : "ja",
    						"type" : "a"
    					});
    				</script></span>
    		</div>
    		<div style="width: 114px; height: 22px; float: left;">
    			<script src="//platform.linkedin.com/in.js" type="text/javascript">
    				lang: ja_JP
    			</script>
    			<script type="IN/Share" data-counter="right"></script>
    		</div>
    		<div style="width: 112px; height: 22px; float: left;">
    			<iframe
    				scrolling="no" frameborder="0" id="fbframe"
				width="164" height="46" style="border:none;overflow:hidden" 
				allowTransparency="true"></iframe>
    		</div>
    		<script type="text/javascript">
    			(function() {
    				var url = encodeURIComponent(location.href);
    				document.getElementById('fbframe').src="//www.facebook.com/plugins/like.php?href=" + url + 
    				"&width=164&layout=button_count&action=like&show_faces=true&share=true&height=46&appId=1613776965579453"
    			})();
    		</script>
    	</div>
    	<script type="text/javascript">
    		!function(d, i) {
    			if (!d.getElementById(i)) {
    				var j = d.createElement("script");
    				j.id = i;
    				j.src = "https://widgets.getpocket.com/v1/j/btn.js?v=1";
    				var w = d.getElementById(i);
    				d.body.appendChild(j);
    			}
    		}(document, "pocket-btn-js");
    	</script>
    	<!-- ソーシャルボタンここまで -->
	
        <div class="content-wrapper__inner">
            

  <article class="post-container post-container--single">

    <header class="post-header">
      <div class="post-meta">
        <time datetime="14 Apr 2017" class="post-meta__date date">14 Apr 2017</time> &#8226; <span class="post-meta__tags tags">on <a href="http://tech.innovation.co.jp/tag/syoga">syoga</a>, <a href="http://tech.innovation.co.jp/tag/log"> log</a>, <a href="http://tech.innovation.co.jp/tag/Azure"> Azure</a>, <a href="http://tech.innovation.co.jp/tag/Computer-Vision-A-P-I"> Computer Vision API</a>, <a href="http://tech.innovation.co.jp/tag/Nodejs"> Node.js</a>, <a href="http://tech.innovation.co.jp/tag/A-W-S"> AWS</a>, <a href="http://tech.innovation.co.jp/tag/Lambda"> Lambda</a>, <a href="http://tech.innovation.co.jp/tag/L-I-N-E"> LINE</a></span>
        <span class="post-meta__author author"><img src="https://avatars0.githubusercontent.com/u/20530620?v=3" alt="profile image for " class="avatar post-meta__avatar" /> by </span>
      </div>
      <h1 class="post-title">LINEとLambdaでパンケーキ！ なお話</h1>
    </header>

    <section class="post tag-syoga tag-log tag-Azure tag-Computer-Vision-A-P-I tag-Nodejs tag-A-W-S tag-Lambda tag-L-I-N-E">
      <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>お久しぶりです、SREと呼ぶ方も呼ばれる方もまだ慣れていない syoga です。</p>
</div>
<div class="paragraph">
<p>最近 SRE というチーム名に恥じない業務をするには何をすべきか…<br>
DevOpsってなんでも自動化するだけじゃないよね…等<br>
日々の業務について悶々としていたところ、ドラゴンクエストXIの発売日が決まりました！！
3DSとPS4 というマルチ展開なのでとりあえず両方購入する事にします！</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_azure_machine_learning_3">Azure Machine Learning のお話 その3</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Azure シリーズの第3段となります、前回までのあらすじはこちらです。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>機械学習を学ぶため Azure Machin Training を体験したが、
自分が「作るより使う方が好きマン」だという事に気付き、
Computer Vision API を使ってみた syoga だった…</code></pre>
</div>
</div>
<div class="paragraph">
<p><a href="http://tech.innovation.co.jp/2016/12/09/Azure-Machine-Learning.html">Azure Machine Learning のお話 その1</a></p>
</div>
<div class="paragraph">
<p><a href="http://tech.innovation.co.jp/2017/02/03/Azure-Machine-Learning-2.html">Azure Machine Learning のお話 その2</a></p>
</div>
<div class="paragraph">
<p>その2ではすでに Azure Machine Learning を利用していませんでしたが、<br>
引続き Computer Vision API のお話になります。</p>
</div>
<div class="paragraph">
<p>前回は PC のローカルにある画像を Python を利用し<br>
Computer Vision API に送信しましたが、携帯で撮った写真を<br>
いちいち PC に送るのが面倒くさいので、LINE で画像を送ったら<br>
画像解析結果を返してくれるのが、いいんじゃないかな〜と思いました。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_line_bot">LINE の BOT アカウントを作ってみる</h2>
<div class="sectionbody">
<div class="paragraph">
<p>LINE の BOT アカウント開設手順としては…</p>
</div>
<div class="paragraph">
<p>1.LINE BUSINESS CENTERでユーザ登録<br>
2.LINE Developer でBOTアカウントを作成<br>
3.API KEY をメモ</p>
</div>
<div class="paragraph">
<p>という事で詳細は各自検索していただればと存じます。</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="/images/syoga/aml3/azure3_1.png" alt="azure3_1.png"></span></p>
</div>
<div class="paragraph">
<p>ブログ用 bot というアカウントを作成しました、<br>
アイコンはフリー素材でおなじみの「いらすとや」さんの画像です、<br>
画像解析感のある緊迫した画像をチョイスしました。<br></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="__">構成はどうする？</h2>
<div class="sectionbody">
<div class="paragraph">
<p>構成はこうしました。<br>
LINE &#8592;&#8594; API Gateway &#8592;&#8594; Lambda &#8592;&#8594; Azure(Computer Vision API, Translate） or ぐるなび</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="/images/syoga/aml3/azure3_2.png" alt="azure3_2.png"></span></p>
</div>
<div class="paragraph">
<p>ぐるなび…！？</p>
</div>
<div class="paragraph">
<p>この「！？」の表現が分かる人は私と同い年だと思いますが、<br>
ぐるなびの API も使います。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="__node_js">せっかくだから俺はこのNode.jsを選ぶぜ！！</h2>
<div class="sectionbody">
<div class="paragraph">
<p>前回 Python で実装しましたが、今回は Node.js で実装します、<br>
モジュールは余り使いたくなかったのですが、無理でした！</p>
</div>
<div class="paragraph">
<p>ソースは以下の通りです、長いので軽く説明します</p>
</div>
<div class="paragraph">
<p>・LINEからメッセージ受信<br>
・メッセージのタイプを判定<br>
・画像だったら Computer Vison API で画像解析し、<br>
　翻訳したメッセージを送信者にプッシュ<br>
・位置情報ならぐるなび API で付近のパンケーキ店を検索し<br>
　検索結果をメッセージ送信者にプッシュ<br>
・その他のタイプは適当なメッセージを送信者にプッシュ</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>'use strict';

// モジュールロード
const fs     = require('fs');
const url    = require('url');
const https  = require('https');
const crypto = require('crypto');
const sleep  = require('sleep-async');
const aws    = require('aws-sdk');
const requestPromise = require('request-promise');

// AWS
const BACKET = 'バケット名';
const S3URL  = 'https://s3-ap-northeast-1.amazonaws.com/' + BACKET + '/';

// LINE
const CHANNEL_ACCESS_TOKEN = 'LINE キー';

// 画像ファイル名
const IMAGE_NAME = crypto.randomBytes(8).toString('hex') + '.png';

// テキストメッセージ送信
function pushTexeMessage(text, userId) {

    console.log('Start:pushTexeMessage');

    // API 呼出パラメータ(text)
    let parmText = {
        hostname: 'api.line.me',
        path: '/v2/bot/message/push',
        headers: {
            'Content-type' : 'application/json; charset=UTF-8',
            'Authorization': 'Bearer ' + CHANNEL_ACCESS_TOKEN
        },
        method: 'POST'
    };

    // Send Massage Object 設定
    let pushMassage = JSON.stringify(
        {
            to: userId,
            messages: [{type: 'text', text: text}]
        }
    );

    console.log(pushMassage);

    // POST リクエスト
    let req = https.request(parmText, function(res) {
        req.on('data', function(res) {
            console.log(res.toString());
        }).on('error', function(e) {
            console.log(e.stack);
        });
    });

    // メッセージをpush
    sleep().sleep(300, function() {
        req.write(pushMassage);
        req.end();
    });

    console.log('End:pushTexeMessage');
}

// 受信メッセージから画像を取得
function getMessageImage(id, callback) {

    console.log('Start:getMessageImage');

    // API 呼出パラメータ(image)
    let paramImage = {
        hostname: 'api.line.me',
        path:     '/v2/bot/message/' + id + '/content',
        headers: {
            'Authorization': 'Bearer ' + CHANNEL_ACCESS_TOKEN
        },
        method: 'GET'
    };

    let resData = [];
    let image;

    // GET リクエスト
    let req = https.request(paramImage, function(res) {
        res.on('data', function(chunk) {
            resData.push(new Buffer(chunk));
        }).on('error', function(e) {
            console.log(e.stack);
        }).on('end', function(){
            image = Buffer.concat(resData);
            console.log('End:getMessageImage');
            callback(image);
        });
    });

    req.end();
}

// S3へ画像アップロード
function saveImageS3(image, callback) {

    console.log('Start:saveImageS3');

    aws.config.region = 'ap-northeast-1';

    let s3     = new aws.S3();
    let params = {
        Bucket: BACKET,
        Key:    IMAGE_NAME,
        ACL:    'public-read',
        Body:   image
    };

    // 画像アップロード
    s3.putObject(params, function(e, data) {
        if(!e) {
            console.log('End:saveImageS3');
            callback();
        } else {
            console.log(e.stack);
        }
    });
}

// ComputerVisionAPI 呼出
function callMSComputerVisionAPI(callback) {

    console.log('Start:callMSComputerVisionAPI');

    // S3 画像 URL
    let urlImage = S3URL + IMAGE_NAME;

    // ComputerVisionAPI のレスポンス指定
    let params = 'visualFeatures=Categories, Tags, Description, Faces';

    // ComputerVisionAPI
    let urlObj = {
        protocol: 'https',
        hostname: 'westus.api.cognitive.microsoft.com',
        pathname: 'vision/v1.0/analyze',
        search  : params
    };

    let sendData = {
        "uri"      : url.format(urlObj),
        "method"   : "POST",
        "type"     : "POST",
        "encoding" : "binary",
        "headers"  : {
            "Content-Type": "application/json",
            "Ocp-Apim-Subscription-Key": "Computer Vision API キー"
        },
        "body"     : '{"url":"' + urlImage + '"}'
    };

    // お問合わせ
    requestPromise(sendData).then(function(result) {
        let cvResult  = JSON.parse(result);
        console.log('End:callMSComputerVisionAPI');
        callback(cvResult);
    }).catch(function(e) {
        console.log(e.stack);
    }).done();
}

// ぐるなび API 呼出し
function callGurunaviAPI(latitude, longitude, callback) {

    console.log('Start:callGrunaviAPI');

    // リクエストパラメータ
    let grnvParam = {
        "keyid"       : 'ぐるなび API キー',
        "format"      : 'json',
        "input_coordinates_mode" : 1,
        "latitude"    : latitude,
        "longitude"   : longitude,
        "hit_per_page": 3,
        "freeword"    : 'パンケーキ'
    };

    let grnvSendDate = {
        url     : 'https://api.gnavi.co.jp/RestSearchAPI/20150630/1',
        headers : {'Content-Type' : 'application/json; charset=UTF-8'},
        qs      : grnvParam,
        json    : true
    };

    requestPromise(grnvSendDate).then(function(result) {
        console.log('End:callGrunaviAPI');
        callback(result);
    }).catch(function(e) {
        console.log(e.stack);
    }).done();
}

// アクセストークン取得
function getAccessToken(callback) {

    console.log('Start:getAccessToken');

    let accessParams  = {
        'Content-Type': 'application/json',
        'Accept'      : 'application/jwt',
        'Ocp-Apim-Subscription-Key': 'Translate　キー'
    };

    let accessData = {
         url    : 'https://api.cognitive.microsoft.com/sts/v1.0/issueToken',
         method : 'POST',
         headers: accessParams,
         json   : true
    };

    requestPromise(accessData, function(e, result) {
        if(!e) {
            console.log('End:getAccessToken');
            callback(result.body);
        } else {
            console.log(e.stack);
        }
    });
}

// Translate Text 呼出し
function callTranslateAPI(accessToken, text, callback) {

    console.log('Start:callTranslateAPI');

    let url = 'https://api.microsofttranslator.com/v2/http.svc/Translate',
        appid    = 'Bearer ' + accessToken,
        from     = 'en',
        to       = 'ja';

    let uri = url + '?appid=' + appid +
              '&amp;text=' + text + '&amp;from=' + from + '&amp;to=' + to;

    let header = {
        'Accept': 'application/xml'
    };

    let option = {
        url: encodeURI(uri),
        method: 'GET',
        headers: header,
        json: true
    };

    requestPromise(option, function(e, result) {
        if(!e) {
            console.log('End:callTranslateAPI');
            callback(result.body.replace(/&lt;("[^"]*"|'[^']*'|[^'"&gt;])*&gt;/g, ''));
        } else {
            console.log(e.stack);
        }
    });
}

// ここから処理開始
exports.handler = (event, context) =&gt; {

    console.log('Start:LINE BOT');

    let jsonObj     = JSON.parse(event.body);
    let lineMessage = jsonObj.events[0];

    // メッセージデータ取得
    let message = lineMessage.message;
    let type    = message.type;
    let id      = message.id;

    // ユーザID 取得
    let source  = lineMessage.source;
    let userId  = source.userId;

    switch(type) {
    // イメージ
    case('image'):
        pushTexeMessage('ちょっと待ってもらえるかな？', userId);

        // 画像取得
        getMessageImage(id, function(image) {
            // 取得画像をS3に保存
            saveImageS3(image, function() {
                // Microsoft ComputerVisionAPI 呼出し
                callMSComputerVisionAPI(function(cvResult) {
                    // 解析結果を翻訳して送信
                    if(cvResult.faces.length != 0) {
                        let faces = 'この画像には以下の人が含まれていそうかな？\n';

                        for(let cntFaces in cvResult.faces) {
                            let gender = cvResult.faces[cntFaces].gender;
                            if(gender == 'Female') {
                                gender = '女性';
                            } else {
                                gender = '男性';
                            }

                            if(cntFaces != cvResult.faces.length -1) {
                                faces += '「' + cvResult.faces[cntFaces].age + '歳の' + gender + ' 」\n';
                            } else {
                                faces += '「' + cvResult.faces[cntFaces].age + '歳の' + gender + ' 」';
                            }
                        }
                        pushTexeMessage(faces, userId);
                    }

                    getAccessToken(function(accessToken) {
                        callTranslateAPI(accessToken, cvResult.description.captions[0].text, function(caption) {
                            let caption_jp = 'この画像にタイトルをつけるとしたら「' + caption + '」かな？';
                            pushTexeMessage(caption_jp, userId);
                        });
                    });

                    let tags_jp = 'この画像には以下の物が含まれていそうかな？\n';
                    for(let cntTags in cvResult.tags) {

                        getAccessToken(function(accessToken) {
                            callTranslateAPI(accessToken, cvResult.tags[cntTags].name, function(tags) {
                                sleep().sleep(500, function() {
                                    if(cntTags != cvResult.tags.length -1) {
                                        tags_jp += '「' + tags + '」\n';
                                    } else {
                                        tags_jp += '「' + tags + '」';
                                        pushTexeMessage(tags_jp, userId);
                                    }
                                });
                            });
                        });
                    }
               });
            });
        });
        break;
    // 位置情報
    case('location'):
        // ぐるなび API 呼出し
        callGurunaviAPI(message.latitude, message.longitude, function(grnvResult) {

            if(grnvResult.rest.length != 0) {
                pushTexeMessage('近くにパンケーキが食べられるお店があるかな。', userId);
                let rest = '';
                // 検索結果を送信
                for(let cntRest = 0; cntRest &lt; grnvResult.rest.length; cntRest++) {
                    console.log(cntRest);
                    rest =  '[店名] : ' + grnvResult.rest[cntRest].name + '\n';
                    rest += '[住所] : ' + grnvResult.rest[cntRest].address + '\n';
                    rest += '[URL] : '  + grnvResult.rest[cntRest].url;

                    pushTexeMessage(rest, userId);
                }
            } else {
                pushTexeMessage('近くにパンケーキが食べられるお店はないかな。', userId);
            }
        });
        break;
    // テキスト
    case('text'):
        pushTexeMessage('え？「' + message.text + '」？\nそんな事より画像を送ってくれないかな？', userId);
        break;
    // ビデオ
    case('video'):
        pushTexeMessage('動画もいいけど画像を送ってくれないかな？', userId);
        break;
    // オーディオ
    case('audio'):
        pushTexeMessage('音声もいいけど画像を送ってくれないかな？', userId);
        break;
    // その他
    default:
        pushTexeMessage('そんな事より画像を送ってくれないかな？', userId);
        break;
    }
    console.log('End:LINE BOT');
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>■気になる点<br>
・callback 地獄！！<br>
・同期させるために async を使用…せず、無理矢理スリープさせている。<br>
・異常系は全て無視。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="___2">早速動かそう！！</h2>
<div class="sectionbody">
<div class="paragraph">
<p>まずはテキストメッセージを送ります。</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="/images/syoga/aml3/azure3_3.png" alt="azure3_3.png"></span></p>
</div>
<div class="paragraph">
<p>お、なんかイラっとする返信だな…</p>
</div>
<div class="paragraph">
<p>次は位置情報。</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="/images/syoga/aml3/azure3_5.png" alt="azure3_5.png"></span></p>
</div>
<div class="paragraph">
<p>おー、ちゃんと検索結果が来ました、ただイラっとするのは変わらず…</p>
</div>
<div class="paragraph">
<p>##　そして画像解析 DA☆</p>
</div>
<div class="paragraph">
<p>まずはうちの猫ちゃん。</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="/images/syoga/aml3/azure3_4.png" alt="azure3_4.png"></span></p>
</div>
<div class="paragraph">
<p>翻訳精度、画像解析結果が微妙なのか？？<br>
犬を飼っている事もバレている！？</p>
</div>
<div class="paragraph">
<p>次はYAGASAKI さん。</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="/images/syoga/aml3/azure3_6.png" alt="azure3_6.png"></span></p>
</div>
<div class="paragraph">
<p>お、年齢が出ましたね！33…！？<br>
「机の前に立っている人」は「お…おぅ」って感じです<br>
直訳感がいなめないですね。</p>
</div>
<div class="paragraph">
<p>次は KTN さん。</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="/images/syoga/aml3/azure3_7.png" alt="azure3_7.png"></span></p>
</div>
<div class="paragraph">
<p>あれ？前回より若返っている！ケーキではなくティラミスだけど、許容範囲ですね！</p>
</div>
<div class="paragraph">
<p>さらに、AMIさんとKTNさん</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="/images/syoga/aml3/azure3_8.png" alt="azure3_8.png"></span></p>
</div>
<div class="paragraph">
<p>あれ？KTNさん老けた！！<br>
AMIさんは…これ以上は野暮なので止めます！<br>
翻訳しているのでアレですが、カップルは2人組という意味ですかね。</p>
</div>
<div class="paragraph">
<p>そしてKATOさんとYAIZUさん！</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="/images/syoga/aml3/azure3_9.png" alt="azure3_9.png"></span></p>
</div>
<div class="paragraph">
<p>お、年齢はほぼバッチシ！！凄い！<br>
キャプションは翻訳しない方がいいかもですね<br>
カップル率の高さが気になります。</p>
</div>
<div class="paragraph">
<p>と言う訳で画像解析結果は、まずまずかなという気がします！</p>
</div>
<div class="paragraph">
<p>メガネ型のデバイスで周りを認識して近くに何があるかや、<br>
相手の表情から感情を音声で教えてくれるって事が手軽にできそうですね。</p>
</div>
<div class="paragraph">
<p>遠隔操作のロボットや、視覚障害がある方等に、色々と役立つ物ができそうです！</p>
</div>
<div class="paragraph">
<p>完</p>
</div>
</div>
</div>
    </section>

  </article>




            <footer class="footer">
                <span class="footer__copyright">&copy; 2017. All rights reserved.</span>
                <span class="footer__copyright"><a href="http://uno.daleanthony.com" title="link to page for Uno Ghost theme">Uno theme</a> by <a href="http://daleanthony.com" title="link to website for Dale-Anthony">Dale-Anthony</a></span>
                <span class="footer__copyright">Proudly published with <a href="http://hubpress.io" title="link to Hubpress website">Hubpress</a></span>
            </footer>
        </div>
    </div>

    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js?v="></script> <script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.9.0/moment-with-locales.min.js?v="></script> <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/highlight.min.js?v="></script> 
      <script type="text/javascript">
        jQuery( document ).ready(function() {
          // change date with ago
          jQuery('ago.ago').each(function(){
            var element = jQuery(this).parent();
            element.html( moment(element.text()).fromNow());
          });
        });

        hljs.initHighlightingOnLoad();      
      </script>

    <script type="text/javascript" src="//tech.innovation.co.jp/themes/uno/assets/js/main.js?v=1.0.0"></script>
    

</body>
</html>
