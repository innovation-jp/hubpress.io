<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <title>WordPressサイトのhttps化をした時のお話など - イノベーション　エンジニアブログ</title>

    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <meta name="description" content="">

    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="WordPressサイトのhttps化をした時のお話など">
    <meta name="twitter:description" content="">

    <meta property="og:type" content="article">
    <meta property="og:title" content="WordPressサイトのhttps化をした時のお話など">
    <meta property="og:description" content="">

    <link href="/favicon.ico" rel="shortcut icon" type="image/x-icon">
    <link href="/apple-touch-icon-precomposed.png" rel="apple-touch-icon">
    
<script type="text/javascript">
var _trackingid = 'LFT-10003-1';

(function() {
  var lft = document.createElement('script'); lft.type = 'text/javascript'; lft.async = true;
  lft.src = document.location.protocol + '//test.list-finder.jp/js/ja/track_test.js';
  var snode = document.getElementsByTagName('script')[0]; snode.parentNode.insertBefore(lft, snode);
})();
</script>

<script type="text/javascript">
var _trackingid = 'LFT-10003-1';

(function() {
  var lft = document.createElement('script'); lft.type = 'text/javascript'; lft.async = true;
  lft.src = document.location.protocol + '//track.list-finder.jp/js/ja/track_prod_wao.js';
  var snode = document.getElementsByTagName('script')[0]; snode.parentNode.insertBefore(lft, snode);
})();
</script>

    <link rel="stylesheet" type="text/css" href="//tech.innovation.co.jp/themes/uno/assets/css/uno.css?v=1.0.0" />

    <link rel="canonical" href="http://tech.innovation.co.jp/2016/05/26/Such-as-the-story-of-when-he-turned-into-https-of-Wordpress-site.html" />
    
    <meta property="og:site_name" content="イノベーション　エンジニアブログ" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="WordPressサイトのhttps化をした時のお話など" />
    <meta property="og:description" content="こんにちは。 弊社エンジニアグループではもう一番若手ではなくなったの3年目エンジニア小笹です。 先日弊社で運営している BtoBマーケティングイノベーション をhttps化したのですが、 その時考えたり感じたりしたお話をさせていただればと思います。 前提 BtoBマーケティングイノベーション とさらっと書きましたが、 弊社が運営しているBtoBマーケティングの情報発信用ブログのことです。 社内のメンバーが個々人の得意なことや調べたことを記事にまとめたものや、 外部のイベントに参加した際のレポートなどを公開しております。 タイトルに「ブログ」とあるように..." />
    <meta property="og:url" content="http://tech.innovation.co.jp/2016/05/26/Such-as-the-story-of-when-he-turned-into-https-of-Wordpress-site.html" />
    <meta property="article:published_time" content="2016-05-25T15:00:00.000Z" />
    <meta property="article:modified_time" content="2016-05-27T00:39:31.726Z" />
    <meta property="article:tag" content="SecondPost" />
    <meta property="article:tag" content="Oz" />
    <meta property="article:tag" content="https" />
    <meta property="article:tag" content="WordPress" />
    
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="WordPressサイトのhttps化をした時のお話など" />
    <meta name="twitter:description" content="こんにちは。 弊社エンジニアグループではもう一番若手ではなくなったの3年目エンジニア小笹です。 先日弊社で運営している BtoBマーケティングイノベーション をhttps化したのですが、 その時考えたり感じたりしたお話をさせていただればと思います。 前提 BtoBマーケティングイノベーション とさらっと書きましたが、 弊社が運営しているBtoBマーケティングの情報発信用ブログのことです。 社内のメンバーが個々人の得意なことや調べたことを記事にまとめたものや、 外部のイベントに参加した際のレポートなどを公開しております。 タイトルに「ブログ」とあるように..." />
    <meta name="twitter:url" content="http://tech.innovation.co.jp/2016/05/26/Such-as-the-story-of-when-he-turned-into-https-of-Wordpress-site.html" />
    
    <script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Article",
    "publisher": "イノベーション　エンジニアブログ",
    "author": {
        "@type": "Person",
        "name": "katoK",
        "image": "https://avatars.githubusercontent.com/u/70055?v=3",
        "url": "undefined/author/undefined",
        "sameAs": null
    },
    "headline": "WordPressサイトのhttps化をした時のお話など",
    "url": "http://tech.innovation.co.jp/2016/05/26/Such-as-the-story-of-when-he-turned-into-https-of-Wordpress-site.html",
    "datePublished": "2016-05-25T15:00:00.000Z",
    "dateModified": "2016-05-27T00:39:31.726Z",
    "keywords": "SecondPost, Oz, https, WordPress",
    "description": "こんにちは。 弊社エンジニアグループではもう一番若手ではなくなったの3年目エンジニア小笹です。 先日弊社で運営している BtoBマーケティングイノベーション をhttps化したのですが、 その時考えたり感じたりしたお話をさせていただればと思います。 前提 BtoBマーケティングイノベーション とさらっと書きましたが、 弊社が運営しているBtoBマーケティングの情報発信用ブログのことです。 社内のメンバーが個々人の得意なことや調べたことを記事にまとめたものや、 外部のイベントに参加した際のレポートなどを公開しております。 タイトルに「ブログ」とあるように..."
}
    </script>

    <meta name="generator" content="Ghost ?" />
    <link rel="alternate" type="application/rss+xml" title="イノベーション　エンジニアブログ" href="http://tech.innovation.co.jp/rss" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/styles/default.min.css">


</head>
<body class="post-template tag-Second-Post tag-Oz tag-https tag-Word-Press no-js">

    <span class="mobile btn-mobile-menu">
        <i class="icon icon-list btn-mobile-menu__icon"></i>
        <i class="icon icon-x-circle btn-mobile-close__icon hidden"></i>
    </span>

    <header class="panel-cover panel-cover--collapsed " >
      <div class="panel-main">
    
        <div class="panel-main__inner panel-inverted">
        <div class="panel-main__content">
    
            <h1 class="panel-cover__title panel-title"><a href="http://tech.innovation.co.jp" title="link to homepage for イノベーション　エンジニアブログ">イノベーション　エンジニアブログ</a></h1>
            <hr class="panel-cover__divider" />
            <p class="panel-cover__description">株式会社イノベーションのエンジニアたちの技術系ブログです</p>
            <hr class="panel-cover__divider panel-cover__divider--secondary" />
    
            <div class="navigation-wrapper">
    
              <nav class="cover-navigation cover-navigation--primary">
                <ul class="navigation">
                  <li class="navigation__item"><a href="http://tech.innovation.co.jp/#blog" title="link to イノベーション　エンジニアブログ blog" class="blog-button">Blog</a></li>
                </ul>
              </nav>
    
              
              
              <nav class="cover-navigation navigation--social">
                <ul class="navigation">
              
              
              
              
              
              
              
              
              
              
                </ul>
              </nav>
              
    
            </div>
    
          </div>
    
        </div>
    
        <div class="panel-cover--overlay"></div>
      </div>
    </header>

    <div class="content-wrapper">
        <div class="content-wrapper__inner">
            

  <article class="post-container post-container--single">

    <header class="post-header">
      <div class="post-meta">
        <time datetime="26 May 2016" class="post-meta__date date">26 May 2016</time> &#8226; <span class="post-meta__tags tags">on <a href="http://tech.innovation.co.jp/tag/Second-Post">SecondPost</a>, <a href="http://tech.innovation.co.jp/tag/Oz">Oz</a>, <a href="http://tech.innovation.co.jp/tag/https">https</a>, <a href="http://tech.innovation.co.jp/tag/Word-Press">WordPress</a></span>
        <span class="post-meta__author author"><img src="https://avatars.githubusercontent.com/u/70055?v=3" alt="profile image for katoK" class="avatar post-meta__avatar" /> by katoK</span>
      </div>
      <h1 class="post-title">WordPressサイトのhttps化をした時のお話など</h1>
    </header>

    <section class="post tag-Second-Post tag-Oz tag-https tag-Word-Press">
      <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>こんにちは。
弊社エンジニアグループでは<strong>もう</strong>一番若手ではなくなったの3年目エンジニア小笹です。</p>
</div>
<div class="paragraph">
<p>先日弊社で運営している <a href="https://www.innovation.co.jp/b2blog/">BtoBマーケティングイノベーション</a> をhttps化したのですが、<br>
その時考えたり感じたりしたお話をさせていただればと思います。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="__">前提</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://www.innovation.co.jp/b2blog/">BtoBマーケティングイノベーション</a> とさらっと書きましたが、<br>
弊社が運営しているBtoBマーケティングの情報発信用ブログのことです。</p>
</div>
<div class="paragraph">
<p>社内のメンバーが個々人の得意なことや調べたことを記事にまとめたものや、<br>
外部のイベントに参加した際のレポートなどを公開しております。</p>
</div>
<div class="paragraph">
<p>タイトルに「ブログ」とあるように<br>
基本的に記事投稿がメインの作業になるためWordPressが採択されております。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_wordpress">WordPressって何？</h2>
<div class="sectionbody">
<div class="paragraph">
<p>よく聞くとは思うのですが、おさらいです。</p>
</div>
<div class="paragraph">
<p>WordPressはオープンソースのブログソフトウェアで、<br>
最初のバージョンが出たのが2003年ということですから<br>
もう10年以上前からあるソフトウェアになるんですね。</p>
</div>
<div class="paragraph">
<p>感覚値ですが、
日本で流行ってきたのはここ5年以内という感じでしょうか？<br>
私も情報収集のため色々なサイトを回遊しますが、WordPressサイトがかなり多いように感じます。<br>
「famous 5 minute install」というフレーズにあるように手軽さなどが導入数を増やしたきっかけでしょうか。</p>
</div>
<div class="paragraph">
<p>ちなみに開発者のMatt Mullenweg氏は日本にもよく来てくださっているようで、<br>
雑誌なんかにもたびたび載っていらっしゃいますから見たことあるかもおられるのではないでしょうか。<br>
32歳、とってもお若いです。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="___2">必要な作業</h2>
<div class="sectionbody">
<div class="paragraph">
<p>さて、弊社のブログとWordPressについてはざっくりご理解いただけたかと思いますので<br>
構成をざっくりお伝えすると</p>
</div>
<div class="paragraph">
<p>ELB →　EC2　 ←→ 　RDS</p>
</div>
<div class="paragraph">
<p>のようになっております。</p>
</div>
<div class="paragraph">
<p>そして弊社の場合httpsで運用するには下記の作業が必要でした。</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>開発環境の構築</p>
</li>
<li>
<p>証明書の設置</p>
</li>
<li>
<p>DB内のパス書き換え</p>
</li>
<li>
<p>phpファイルなどのパス書き換え</p>
</li>
<li>
<p>.htaccessの設定</p>
</li>
</ol>
</div>
<div class="sect2">
<h3 id="_1">1,開発環境の構築</h3>
<div class="paragraph">
<p>まず対象のEC2インスタンスのAMIをとって、<br>
そこから安め(t2.micro)のインスタンスを立ち上げます。</p>
</div>
<div class="paragraph">
<p>次にRDSのスナップショットをとってec2同じ感じでとったやつから立ち上げます。</p>
</div>
<div class="paragraph">
<p>先ほどのec2にSSHで接続してwp-configファイルを書き換え見に行くDBを変えます。</p>
</div>
<div class="paragraph">
<p>次にELBを作成して、ec2を接続します。<br>
作成したELBのDNS名をdigってでてきたIPをhostsに書いてwww.innovation.co.jpでアクセスできるようにしておきます。</p>
</div>
<div class="paragraph">
<p>こんな感じで開発環境がサクッと作れてしまいました。びっくり！！<br>
<code>(実際には色々調べたり教えてもらいながらだったのでかなり時間かかってます)</code></p>
</div>
</div>
<div class="sect2">
<h3 id="_2">2,証明書の設置</h3>
<div class="paragraph">
<p>作成したELBにSSL証明書を設置しましょう！！
AWSの管理画面をぽちぽちすればできてしまうので楽チンです！！</p>
</div>
</div>
<div class="sect2">
<h3 id="_3_db">3,DB内のパス書き換え</h3>
<div class="paragraph">
<p>開発環境なのでゴリゴリやっていきましょう！
ミスったらまた作ればいいのです！！</p>
</div>
<div class="paragraph">
<p>という精神でDB内のデータも書き換えていきます。<br>
WordPressは設定情報やメディア(画像)のパス情報などをDBに保存するようになっているため、<br>
http:〜で保存されているデータはかなりの量あります。<br>
(参照URL:http://wpdocs.osdn.jp/%E3%83%87%E3%83%BC%E3%82%BF%E3%83%99%E3%83%BC%E3%82%B9%E6%A7%8B%E9%80%A0)</p>
</div>
<div class="paragraph">
<p>なのでUPDATE文で一括で書き換えてしまいましょう。<br>
対象はざっくり以下の通り</p>
</div>
<div class="ulist">
<ul>
<li>
<p>wp_options.option_value</p>
</li>
<li>
<p>wp_posts.guid</p>
</li>
<li>
<p>wp_posts.post_content</p>
</li>
<li>
<p>wp_postmeta.meta_value</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>トランザクションはって、慎重かつ大胆に進めていきます。<br>
<strong>えいやっ！</strong></p>
</div>
</div>
<div class="sect2">
<h3 id="_4_php">4,phpファイルなどのパス書き換え</h3>
<div class="paragraph">
<p>DBの中身が書き換わってもheader.phpなどに直でリンクを書いているパターンもあると思います。<br>
ブログの場合はそこまで画面数も多くないでしょうから、ここはチクチクやっていきます。</p>
</div>
</div>
<div class="sect2">
<h3 id="_5_htaccess">5,.htaccessでリダイレクトの設定</h3>
<div class="paragraph">
<p>httpできたユーザをhttpsの環境にリダイレクトしてあげましょう。<br>
これができれば終了です！！</p>
</div>
<div class="paragraph">
<p>が、</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="___3">困ったこと</h2>
<div class="sectionbody">
<div class="paragraph">
<p><strong>いざ、アクセスするとリダイレクトループに入ってしまい表示がうまくいきません……</strong></p>
</div>
<div class="paragraph">
<p>試しに3の工程でやったhttps化の逆にhttp化して5のリダイレクトを切ってみます。 <br>
するとリダイレクトループには入らなくなりました。</p>
</div>
<div class="paragraph">
<p>なぜ！？</p>
</div>
<div class="paragraph">
<p>色々調べてみました。<br>
しかし、WordPressってユーザ数も多い上にエンジニアではない方が、<br>
疑問をそのまま投稿していることなどが非常に多く、ネットの情報が煩雑になっており、<br>
なかなか欲しい情報にたどり着けません。</p>
</div>
<div class="paragraph">
<p>それでもキーワードを変えたり、サーバのログやブラウザのログを見ていって、<br>
WordPress側でリダイレクトしていることがわかりました。</p>
</div>
<div class="paragraph">
<p>それを元に検索やらごにょごにょしてみると<br>
<strong>is_sslが問題っぽいことが判明しました。</strong></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="___4">解決策らしきもの</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-rust" data-lang="rust">function is_ssl() {
  if ( isset($_SERVER['HTTPS']) ) {
    if ( 'on' == strtolower($_SERVER['HTTPS']) )
      return true;
    if ( '1' == $_SERVER['HTTPS'] )
      return true;
  } elseif ( isset($_SERVER['SERVER_PORT']) &amp;amp;&amp;amp; ( '443' == $_SERVER['SERVER_PORT'] ) ) {
    return true;
  }
  return false;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>port443でELBにきてるのがインスタンスに行くときにはport80で行ってしまうため、
$_SERVER[‘HTTPS’]がonにならず、リダイレクトループに突入する感じです。</p>
</div>
<div class="paragraph">
<p>公式でも触れられているのですが、見つけるのが大変でした。。。<br>
<a href="https://codex.wordpress.org/Function_Reference/is_ssl" class="bare">https://codex.wordpress.org/Function_Reference/is_ssl</a></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-rust" data-lang="rust">if (isset($_SERVER['HTTP_X_FORWARDED_PROTO']) &amp;&amp; $_SERVER['HTTP_X_FORWARDED_PROTO'] == 'https')
    $_SERVER['HTTPS'] = 'on';</code></pre>
</div>
</div>
<div class="paragraph">
<p>ふむ、なんか強引な感じがしなくもないですが、
公式ではこんな感じみたいですね。</p>
</div>
<div class="paragraph">
<p>他にも色々やり方はありますが、これにて作業完了！</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="___5">今回の件で考えたこと感じたこと</h2>
<div class="sectionbody">
<div class="paragraph">
<p>作業中お手伝いくださったY氏、N氏ともお話したのですが、強く感じたのはWordpressも当然古くなってくるということです。
今回色々困ったのは以下のような潮流があるからではないでしょうか。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>多くの検索エンジンがhttpsを推奨しだした</p>
</li>
<li>
<p>安価になったりで証明書を取得しやすくなった</p>
</li>
<li>
<p>ロードバランサーなども個人での利用が容易になってきた</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>ざっくり言ってしまえばセキュア化だとかクラウド化という流れの中で、<br>
設計当時の思想ではそのまま適合できない部分が出てきたって感じなのでしょうか。<br>
当たり前っちゃ当たり前ですよね、10年以上経っているわけですから。</p>
</div>
<div class="paragraph">
<p>Matt Mullenweg氏は
<a href="https://ja.wordpress.org/2013/06/05/ten-good-years/">「すばらしき10年間」</a>というポストの中で<br></p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>WordPressのコードには美しいといえないものもあります。WordPressが始まった頃、僕たちの多くはまだPHPを学んでいる途中だったのです。でも、常にユーザーにとっての体験がなるべくスムーズになるように努めてきました。</p>
</div>
</blockquote>
<div class="attribution">
&#8212; <a href="https://ja.wordpress.org/2013/06/05/ten-good-years/">WordPress › Ten Good Years</a>
</div>
</div>
<div class="paragraph">
<p>と環境の変化に対応する中でもあくまでユーザ(非エンジニアであることが多い)の体験が最も重要であるとの姿勢を強く見せています。</p>
</div>
<div class="paragraph">
<p>変化に適応し続けなければシステムとして死んでしまう、<br>
しかし企業がリスクを取りたくないためソフトウェアをクローズに保有してしまう、<br>
WordPressはオープンソースだからこそあるべき姿を純粋に追い続けることができたりするのかもしれません。</p>
</div>
<div class="paragraph">
<p>さらに、同氏はオープンソースについて<br>
イシン株式会社出版のTECH TSUSHINの4月号において<br>
「<em>オープンソースはセキュリティが高く、信用でき、機能的で</em>」
あると述べています。<br>
考え方こそ変えていかなければ、生き残ることは難しいのですね。<br>
窓のガラスですら完全に静止することはないのですから。</p>
</div>
<div class="paragraph">
<p>ちなみに、東京大学名誉教授である養老孟司氏は<br>
「<em>自分が変われば世界も変わる</em>」
と変化について触れているようです。(※要出典)</p>
</div>
<div class="paragraph">
<p>日々勉強し、受容し、咀嚼していくことが、人もシステムも必要ですね。</p>
</div>
<div class="paragraph">
<p>こちらからは以上です。</p>
</div>
</div>
</div>
    </section>

  </article>




            <footer class="footer">
                <span class="footer__copyright">&copy; 2016. All rights reserved.</span>
                <span class="footer__copyright"><a href="http://uno.daleanthony.com" title="link to page for Uno Ghost theme">Uno theme</a> by <a href="http://daleanthony.com" title="link to website for Dale-Anthony">Dale-Anthony</a></span>
                <span class="footer__copyright">Proudly published with <a href="http://hubpress.io" title="link to Hubpress website">Hubpress</a></span>
            </footer>
        </div>
    </div>

    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js?v="></script> <script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.9.0/moment-with-locales.min.js?v="></script> <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/highlight.min.js?v="></script> 
      <script type="text/javascript">
        jQuery( document ).ready(function() {
          // change date with ago
          jQuery('ago.ago').each(function(){
            var element = jQuery(this).parent();
            element.html( moment(element.text()).fromNow());
          });
        });

        hljs.initHighlightingOnLoad();      
      </script>

    <script type="text/javascript" src="//tech.innovation.co.jp/themes/uno/assets/js/main.js?v=1.0.0"></script>
    

</body>
</html>
